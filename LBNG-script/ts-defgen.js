"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const URLClassLoader_1 = require("jvm-types/java/net/URLClassLoader");
const File_1 = require("jvm-types/java/io/File");
const Thread_1 = require("jvm-types/java/lang/Thread");
const Paths_1 = require("jvm-types/java/nio/file/Paths");
// import { HashMap } from "jvm-types/java/util/HashMap";
// import { ArrayList } from "jvm-types/java/util/ArrayList";
const JvmClassMappingKt_1 = require("jvm-types/kotlin/jvm/JvmClassMappingKt");
const Class_1 = require("jvm-types/java/lang/Class");
const ScriptModule_1 = require("jvm-types/net/ccbluex/liquidbounce/script/bindings/features/ScriptModule");
const ClassPath_1 = require("jvm-types/com/google/common/reflect/ClassPath");
const ScriptManager_1 = require("jvm-types/net/ccbluex/liquidbounce/script/ScriptManager");
const LiquidBounce_1 = require("jvm-types/net/ccbluex/liquidbounce/LiquidBounce");
const LocalDate_1 = require("jvm-types/java/time/LocalDate");
const DateTimeFormatter_1 = require("jvm-types/java/time/format/DateTimeFormatter");
const inDev = LiquidBounce_1.LiquidBounce.IN_DEVELOPMENT;
// type: array
/** @type any[] */
const globalEntries = Object.entries(globalThis);
// Function to create a URLClassLoader from a JAR path
function createClassLoaderFromJar(jarPath) {
    try {
        // Create File object for the JAR
        const jarFile = new File_1.File(jarPath);
        // Convert File to URL
        const jarUrl = jarFile.toURI().toURL();
        // Create URLClassLoader with the system class loader as parent
        return new URLClassLoader_1.URLClassLoader([jarUrl], Thread_1.Thread.currentThread().getContextClassLoader());
    }
    catch (e) {
        console.error("Error creating ClassLoader:", e);
        throw e;
    }
}
// Function to load a class from a given ClassLoader
function loadClassFromJar(classLoader, className) {
    try {
        return classLoader.loadClass(className);
    }
    catch (e) {
        console.error(`Error loading class ${className}:`, e);
        throw e;
    }
}
// @ts-expect-error
function findAllClassInfos() {
    // @ts-expect-error
    return Java.from(ClassPath_1.ClassPath.from(Thread_1.Thread.currentThread()
        .getContextClassLoader())
        .getTopLevelClasses()
        // @ts-expect-error
        .asList());
}
function getName(javaClass) {
    const fullName = javaClass.name;
    return fullName.substring(fullName.lastIndexOf(".") + 1);
}
const script = registerScript.apply({
    name: "ts-defgen",
    version: "1.0.0",
    authors: ["commandblock2"],
});
function work(path, packageName) {
    try {
        const loader = createClassLoaderFromJar(path + "/ts-generator.jar");
        const NPMGen = loadClassFromJar(loader, "me.commandblock2.tsGenerator.NPMPackageGenerator");
        const TsGen = loadClassFromJar(loader, "me.ntrrgc.tsGenerator.TypeScriptGenerator");
        const VoidType = loadClassFromJar(loader, "me.ntrrgc.tsGenerator.VoidType");
        const NULL = VoidType.getEnumConstants()[0];
        const javaClasses = globalEntries
            .filter((entry) => entry[1] != undefined)
            .map((entry) => (entry[1] instanceof Class_1.Class ? entry[1] : entry[1].class))
            .filter((entry) => entry != undefined);
        const eventEntries = ReflectionUtil.getDeclaredField(ScriptModule_1.ScriptModule, "LOWERCASE_NAME_EVENT_MAP").entrySet().toArray();
        Client.displayChatMessage("looking for all jvm classes");
        const allClassInfos = findAllClassInfos();
        Client.displayChatMessage(`found ${allClassInfos.length} classes, converting to kotlin classes`);
        const classNames = ["java.net.URLClassLoader",
            "java.nio.file.Paths",
            "java.util.HashMap",
            "java.util.ArrayList",
            "java.util.jar.JarInputStream",
            "java.util.Map",
            "com.google.common.reflect.ClassPath",
            "kotlin.jvm.JvmClassMappingKt"
        ]
            .concat(allClassInfos.map((entry) => {
            try {
                return entry.getName();
            }
            catch (e) {
                return null;
            }
        }));
        const jvmClasses = classNames
            .map((entry) => {
            try {
                return ReflectionUtil.classByName(entry);
            }
            catch (e) {
                return null;
            }
        })
            .filter((entry) => entry != undefined);
        const jvmClassesInKotlin = jvmClasses
            .map((entry) => {
            try {
                return JvmClassMappingKt_1.JvmClassMappingKt.getKotlinClass(entry);
            }
            catch (e) {
                return null;
            }
        })
            .filter((entry) => entry != null);
        Client.displayChatMessage(`converted to ${jvmClassesInKotlin.length} kotlin classes`);
        const kotlinClasses = javaClasses
            .concat([
            // Using the imported class from @embedded
            ReflectionUtil.classByName("net.ccbluex.liquidbounce.script.bindings.features.ScriptModule")
        ])
            .concat(eventEntries.map((entry) => entry[1]))
            .map(entry => {
            try {
                return JvmClassMappingKt_1.JvmClassMappingKt.getKotlinClass(entry);
            }
            catch (e) {
                return null;
            }
        })
            .filter((entry) => entry != undefined)
            .concat(jvmClassesInKotlin);
        const classes = new ArrayList(kotlinClasses);
        Client.displayChatMessage(`generating types for ${classes.length} classes`);
        Client.displayChatMessage("this may take a while, please wait...");
        // @ts-expect-error
        const generated = new TsGen(classes, new HashMap(), new ArrayList(), new ArrayList(), "number", NULL);
        const today = LocalDate_1.LocalDate.now();
        const formatter = DateTimeFormatter_1.DateTimeFormatter.ofPattern('y.M.d');
        Client.displayChatMessage("writing types");
        // @ts-expect-error
        const npmPack = new NPMGen(generated, packageName, `${inDev ? today.format(formatter) : LiquidBounce_1.LiquidBounce.INSTANCE.clientVersion}+${LiquidBounce_1.LiquidBounce.INSTANCE.clientBranch}.${LiquidBounce_1.LiquidBounce.INSTANCE.clientCommit}`, 
        // extraFiles - add the ambient and augmentations files
        `"augmentations/**/*.d.ts", "ambient/ambient.d.ts"`, 
        // extraTypesVersion - add the augmentations and ambient paths  
        `"./augmentations/*", "ambient/ambient.d.ts"`, 
        // otherExtras - add the types field
        `"types": "ambient/ambient.d.ts"`, {
            ">=4.0": {
                "jvm-types": [
                    "./types/*",
                    "./augmentations/*",
                    "ambient/ambient.d.ts"
                ]
            }
        });
        npmPack.writePackageTo(
        // @ts-expect-error
        Paths_1.Paths.get(path + "/types-gen"));
        Client.displayChatMessage("print embedded script types, see log for more info, those are for maintainace use");
        const embeddedDefinition = `
// ambient.ts
// imports
import "../augmentations/index.d.ts"
${javaClasses
            .map((clazz) => {
            return `import { ${getName(clazz)} as ${getName(clazz)}_ } from "../types/${clazz.name.replaceAll(".", "/")}";`;
        })
            .join("\n")}
declare global {


// exports
${globalEntries
            .filter((entry) => entry[1] != undefined)
            .filter((entry) => !(entry[1] instanceof Class_1.Class))
            .filter((entry) => entry[1].class != undefined)
            .map((entry) => `    export const ${entry[0]}: ${getName(entry[1].class)};`)
            .join("\n\n")}

${globalEntries
            .filter((entry) => entry[1] != undefined)
            .filter((entry) => entry[1] instanceof Class_1.Class)
            .map((entry) => {
            const className = getName(entry[1]);
            // Check if this should remain unchanged (add your specific class names here)
            const keepUnchanged = ['ScriptParameterValidator', 'ScriptUnsafeThread'].includes(className);
            if (keepUnchanged) {
                return `    export const ${entry[0]}: ${className};`;
            }
            else {
                // Determine if it's an interface or concrete class
                // You'll need to add logic here to detect interfaces vs concrete classes
                const isInterface = false; // Replace with actual interface detection logic
                if (isInterface) {
                    return `    export const ${entry[0]}: ${className}_;`;
                }
                else {
                    return `    export const ${entry[0]}: typeof ${className}_;`;
                }
            }
        })
            .join("\n\n")}

}
`;
        const importsForScriptEventPatch = `
// imports for
${eventEntries.map((entry) => entry[1]).map((kClassImpl) => `import type { ${kClassImpl.simpleName} } from '../types/${kClassImpl.qualifiedName.replaceAll(".", "/")}.d.ts'`).join("\n")}


`;
        const onEventsForScriptPatch = `
// on events
${eventEntries.map((entry) => `on(eventName: "${entry[0]}", handler: (${entry[0]}Event: ${entry[1].simpleName}) => void): Unit;`).join("\n")}


`;
        Client.displayChatMessage("Generated TypeScript definitions successfully!");
        Client.displayChatMessage(`Output path: ${path}/types-gen`);
        // Output the generated content to console for debugging
        console.log(embeddedDefinition);
        // @ts-expect-error
        const Files = Java.type('java.nio.file.Files');
        // @ts-expect-error
        const filePath = Paths_1.Paths.get(`${path}/types-gen/${packageName}/ambient/ambient.d.ts`);
        // @ts-expect-error
        Files.createDirectories(filePath.getParent());
        Files.writeString(filePath, embeddedDefinition, 
        // @ts-expect-error
        Java.type("java.nio.charset.StandardCharsets").UTF_8);
        // Write the ScriptModule augmentation file
        const augmentationContent = `// ScriptModule augmentation - adds event handler interfaces

// Event type imports
${importsForScriptEventPatch}
import type { Unit } from '../types/kotlin/Unit';

// Augment ScriptModule with specific event handler overloads
declare module '../types/net/ccbluex/liquidbounce/script/bindings/features/ScriptModule' {
    interface ScriptModule {
        on(eventName: "enable" | "disable", handler: () => void): Unit;

        // on events with specific event types
        ${onEventsForScriptPatch}
    }
}
`;
        // @ts-expect-error
        const augmentationFilePath = Paths_1.Paths.get(`${path}/types-gen/${packageName}/augmentations/ScriptModule.augmentation.d.ts`);
        // @ts-expect-error
        Files.createDirectories(augmentationFilePath.getParent());
        Files.writeString(augmentationFilePath, augmentationContent, 
        // @ts-expect-error
        Java.type("java.nio.charset.StandardCharsets").UTF_8);
        console.log(importsForScriptEventPatch);
        console.log(onEventsForScriptPatch);
    }
    catch (e) {
        console.error(e);
        Client.displayChatMessage(`Error generating TypeScript definitions: ${e.message}`);
        e.printStackTrace();
        throw e;
    }
}
const packageName = inDev ? "jvm-types-next" : "jvm-type";
const path = ScriptManager_1.ScriptManager.INSTANCE.root.path;
// @ts-expect-error
if (Java.type("java.lang.System").getenv("CI_BUILD")) {
    work(path, packageName);
    mc.close();
}
script.registerCommand({
    name: "ts-defgen",
    aliases: ["tsgen"],
    parameters: [],
    onExecute() {
        // @ts-expect-error
        UnsafeThread.run(() => work(path, packageName));
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHMtZGVmZ2VuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RzLWRlZmdlbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNFQUFtRTtBQUNuRSxpREFBOEM7QUFFOUMsdURBQW9EO0FBQ3BELHlEQUFzRDtBQUV0RCx5REFBeUQ7QUFFekQsNkRBQTZEO0FBQzdELDhFQUEyRTtBQUMzRSxxREFBa0Q7QUFDbEQsMkdBQXdHO0FBS3hHLDZFQUEwRTtBQUMxRSwyRkFBd0Y7QUFJeEYsa0ZBQThFO0FBQzlFLDZEQUEwRDtBQUMxRCxvRkFBaUY7QUFFakYsTUFBTSxLQUFLLEdBQUcsMkJBQVksQ0FBQyxjQUFjLENBQUE7QUFFekMsY0FBYztBQUNkLGtCQUFrQjtBQUNsQixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRWpELHNEQUFzRDtBQUN0RCxTQUFTLHdCQUF3QixDQUFDLE9BQWU7SUFDN0MsSUFBSSxDQUFDO1FBQ0QsaUNBQWlDO1FBQ2pDLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWxDLHNCQUFzQjtRQUN0QixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFdkMsK0RBQStEO1FBQy9ELE9BQU8sSUFBSSwrQkFBYyxDQUNyQixDQUFDLE1BQU0sQ0FBQyxFQUNSLGVBQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUNqRCxDQUFDO0lBQ04sQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxDQUFDO0lBQ1osQ0FBQztBQUNMLENBQUM7QUFFRCxvREFBb0Q7QUFDcEQsU0FBUyxnQkFBZ0IsQ0FBQyxXQUEyQixFQUFFLFNBQWlCO0lBQ3BF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SUFBSSxHQUFHLDZCQUFhLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFFOUMsbUJBQW1CO0FBQ25CLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO0lBQ25ELElBQUksQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDdkIsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2YsQ0FBQztBQUVELE1BQU0sQ0FBQyxlQUFlLENBQUM7SUFDbkIsSUFBSSxFQUFFLFdBQVc7SUFDakIsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDO0lBQ2xCLFVBQVUsRUFBRSxFQUNYO0lBQ0QsU0FBUztRQUNMLG1CQUFtQjtRQUNuQixZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUNwRCxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVVJMQ2xhc3NMb2FkZXIgfSBmcm9tIFwianZtLXR5cGVzL2phdmEvbmV0L1VSTENsYXNzTG9hZGVyXCI7XG5pbXBvcnQgeyBGaWxlIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL2lvL0ZpbGVcIjtcbmltcG9ydCB7IFVSTCB9IGZyb20gXCJqdm0tdHlwZXMvamF2YS9uZXQvVVJMXCI7XG5pbXBvcnQgeyBUaHJlYWQgfSBmcm9tIFwianZtLXR5cGVzL2phdmEvbGFuZy9UaHJlYWRcIjtcbmltcG9ydCB7IFBhdGhzIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL25pby9maWxlL1BhdGhzXCI7XG5cbi8vIGltcG9ydCB7IEhhc2hNYXAgfSBmcm9tIFwianZtLXR5cGVzL2phdmEvdXRpbC9IYXNoTWFwXCI7XG5cbi8vIGltcG9ydCB7IEFycmF5TGlzdCB9IGZyb20gXCJqdm0tdHlwZXMvamF2YS91dGlsL0FycmF5TGlzdFwiO1xuaW1wb3J0IHsgSnZtQ2xhc3NNYXBwaW5nS3QgfSBmcm9tIFwianZtLXR5cGVzL2tvdGxpbi9qdm0vSnZtQ2xhc3NNYXBwaW5nS3RcIjtcbmltcG9ydCB7IENsYXNzIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL2xhbmcvQ2xhc3NcIjtcbmltcG9ydCB7IFNjcmlwdE1vZHVsZSB9IGZyb20gXCJqdm0tdHlwZXMvbmV0L2NjYmx1ZXgvbGlxdWlkYm91bmNlL3NjcmlwdC9iaW5kaW5ncy9mZWF0dXJlcy9TY3JpcHRNb2R1bGVcIjtcbmltcG9ydCB7IE9iamVjdCBhcyBKYXZhT2JqZWN0IH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL2xhbmcvT2JqZWN0XCI7XG5cbi8vIGltcG9ydCB7IE1hcCBhcyBKYXZhTWFwIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL3V0aWwvTWFwXCI7XG5pbXBvcnQgeyBUaHJvd2FibGUgfSBmcm9tIFwianZtLXR5cGVzL2phdmEvbGFuZy9UaHJvd2FibGVcIjtcbmltcG9ydCB7IENsYXNzUGF0aCB9IGZyb20gXCJqdm0tdHlwZXMvY29tL2dvb2dsZS9jb21tb24vcmVmbGVjdC9DbGFzc1BhdGhcIjtcbmltcG9ydCB7IFNjcmlwdE1hbmFnZXIgfSBmcm9tIFwianZtLXR5cGVzL25ldC9jY2JsdWV4L2xpcXVpZGJvdW5jZS9zY3JpcHQvU2NyaXB0TWFuYWdlclwiO1xuaW1wb3J0IHsgRXhjZXB0aW9uIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL2xhbmcvRXhjZXB0aW9uXCI7XG5pbXBvcnQgeyBGaWxlc0t0IH0gZnJvbSBcImp2bS10eXBlcy9rb3RsaW4vaW8vRmlsZXNLdFwiO1xuaW1wb3J0IHsgRmlsZSBhcyBKYXZhRmlsZSB9IGZyb20gXCJqdm0tdHlwZXMvamF2YS9pby9GaWxlXCI7XG5pbXBvcnQgeyBMaXF1aWRCb3VuY2UgfSBmcm9tIFwianZtLXR5cGVzL25ldC9jY2JsdWV4L2xpcXVpZGJvdW5jZS9MaXF1aWRCb3VuY2VcIlxuaW1wb3J0IHsgTG9jYWxEYXRlIH0gZnJvbSBcImp2bS10eXBlcy9qYXZhL3RpbWUvTG9jYWxEYXRlXCI7XG5pbXBvcnQgeyBEYXRlVGltZUZvcm1hdHRlciB9IGZyb20gXCJqdm0tdHlwZXMvamF2YS90aW1lL2Zvcm1hdC9EYXRlVGltZUZvcm1hdHRlclwiO1xuXG5jb25zdCBpbkRldiA9IExpcXVpZEJvdW5jZS5JTl9ERVZFTE9QTUVOVFxuXG4vLyB0eXBlOiBhcnJheVxuLyoqIEB0eXBlIGFueVtdICovXG5jb25zdCBnbG9iYWxFbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsVGhpcyk7XG5cbi8vIEZ1bmN0aW9uIHRvIGNyZWF0ZSBhIFVSTENsYXNzTG9hZGVyIGZyb20gYSBKQVIgcGF0aFxuZnVuY3Rpb24gY3JlYXRlQ2xhc3NMb2FkZXJGcm9tSmFyKGphclBhdGg6IHN0cmluZyk6IFVSTENsYXNzTG9hZGVyIHtcbiAgICB0cnkge1xuICAgICAgICAvLyBDcmVhdGUgRmlsZSBvYmplY3QgZm9yIHRoZSBKQVJcbiAgICAgICAgY29uc3QgamFyRmlsZSA9IG5ldyBGaWxlKGphclBhdGgpO1xuXG4gICAgICAgIC8vIENvbnZlcnQgRmlsZSB0byBVUkxcbiAgICAgICAgY29uc3QgamFyVXJsID0gamFyRmlsZS50b1VSSSgpLnRvVVJMKCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIFVSTENsYXNzTG9hZGVyIHdpdGggdGhlIHN5c3RlbSBjbGFzcyBsb2FkZXIgYXMgcGFyZW50XG4gICAgICAgIHJldHVybiBuZXcgVVJMQ2xhc3NMb2FkZXIoXG4gICAgICAgICAgICBbamFyVXJsXSxcbiAgICAgICAgICAgIFRocmVhZC5jdXJyZW50VGhyZWFkKCkuZ2V0Q29udGV4dENsYXNzTG9hZGVyKClcbiAgICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBjcmVhdGluZyBDbGFzc0xvYWRlcjpcIiwgZSk7XG4gICAgICAgIHRocm93IGU7XG4gICAgfVxufVxuXG4vLyBGdW5jdGlvbiB0byBsb2FkIGEgY2xhc3MgZnJvbSBhIGdpdmVuIENsYXNzTG9hZGVyXG5mdW5jdGlvbiBsb2FkQ2xhc3NGcm9tSmFyKGNsYXNzTG9hZGVyOiBVUkxDbGFzc0xvYWRlciwgY2xhc3NOYW1lOiBzdHJpbmcpOiBDbGFzczxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gY2xhc3NMb2FkZXIubG9hZENsYXNzKGNsYXNzTmFtZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBsb2FkaW5nIGNsYXNzICR7Y2xhc3NOYW1lfTpgLCBlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICB9XG59XG5cbi8vIEB0cy1leHBlY3QtZXJyb3JcbmZ1bmN0aW9uIGZpbmRBbGxDbGFzc0luZm9zKCk6IENsYXNzSW5mbzxhbnk+W10ge1xuICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICByZXR1cm4gSmF2YS5mcm9tKFxuICAgICAgICBDbGFzc1BhdGguZnJvbShcbiAgICAgICAgICAgIFRocmVhZC5jdXJyZW50VGhyZWFkKClcbiAgICAgICAgICAgICAgICAuZ2V0Q29udGV4dENsYXNzTG9hZGVyKClcbiAgICAgICAgKVxuICAgICAgICAgICAgLmdldFRvcExldmVsQ2xhc3NlcygpXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICAuYXNMaXN0KClcbiAgICApO1xufVxuXG5cbmZ1bmN0aW9uIGdldE5hbWUoamF2YUNsYXNzOiBDbGFzczxhbnk+KTogc3RyaW5nIHtcbiAgICBjb25zdCBmdWxsTmFtZSA9IGphdmFDbGFzcy5uYW1lO1xuICAgIHJldHVybiBmdWxsTmFtZS5zdWJzdHJpbmcoZnVsbE5hbWUubGFzdEluZGV4T2YoXCIuXCIpICsgMSk7XG59XG5cbmNvbnN0IHNjcmlwdCA9IHJlZ2lzdGVyU2NyaXB0LmFwcGx5KHtcbiAgICBuYW1lOiBcInRzLWRlZmdlblwiLFxuICAgIHZlcnNpb246IFwiMS4wLjBcIixcbiAgICBhdXRob3JzOiBbXCJjb21tYW5kYmxvY2syXCJdLFxufSk7XG5cbmZ1bmN0aW9uIHdvcmsocGF0aDogc3RyaW5nLCBwYWNrYWdlTmFtZTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbG9hZGVyID0gY3JlYXRlQ2xhc3NMb2FkZXJGcm9tSmFyKFxuICAgICAgICAgICAgcGF0aCArIFwiL3RzLWdlbmVyYXRvci5qYXJcIlxuICAgICAgICApO1xuICAgICAgICBjb25zdCBOUE1HZW4gPSBsb2FkQ2xhc3NGcm9tSmFyKFxuICAgICAgICAgICAgbG9hZGVyLFxuICAgICAgICAgICAgXCJtZS5jb21tYW5kYmxvY2syLnRzR2VuZXJhdG9yLk5QTVBhY2thZ2VHZW5lcmF0b3JcIlxuICAgICAgICApO1xuICAgICAgICBjb25zdCBUc0dlbiA9IGxvYWRDbGFzc0Zyb21KYXIoXG4gICAgICAgICAgICBsb2FkZXIsXG4gICAgICAgICAgICBcIm1lLm50cnJnYy50c0dlbmVyYXRvci5UeXBlU2NyaXB0R2VuZXJhdG9yXCJcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgVm9pZFR5cGUgPSBsb2FkQ2xhc3NGcm9tSmFyKFxuICAgICAgICAgICAgbG9hZGVyLFxuICAgICAgICAgICAgXCJtZS5udHJyZ2MudHNHZW5lcmF0b3IuVm9pZFR5cGVcIlxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IE5VTEwgPSBWb2lkVHlwZS5nZXRFbnVtQ29uc3RhbnRzKClbMF07XG5cbiAgICAgICAgY29uc3QgamF2YUNsYXNzZXMgPSBnbG9iYWxFbnRyaWVzXG4gICAgICAgICAgICAuZmlsdGVyKChlbnRyeSkgPT4gZW50cnlbMV0gIT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgLm1hcCgoZW50cnkpID0+IChlbnRyeVsxXSBpbnN0YW5jZW9mIENsYXNzID8gZW50cnlbMV0gOiBlbnRyeVsxXS5jbGFzcykpXG4gICAgICAgICAgICAuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkgIT0gdW5kZWZpbmVkKTtcblxuICAgICAgICBjb25zdCBldmVudEVudHJpZXMgPSAoUmVmbGVjdGlvblV0aWwuZ2V0RGVjbGFyZWRGaWVsZChTY3JpcHRNb2R1bGUgYXMgdW5rbm93biBhcyBDbGFzczxKYXZhT2JqZWN0PiwgXCJMT1dFUkNBU0VfTkFNRV9FVkVOVF9NQVBcIikgYXMgSmF2YU1hcCkuZW50cnlTZXQoKS50b0FycmF5KCk7XG5cbiAgICAgICAgQ2xpZW50LmRpc3BsYXlDaGF0TWVzc2FnZShcImxvb2tpbmcgZm9yIGFsbCBqdm0gY2xhc3Nlc1wiKVxuICAgICAgICBjb25zdCBhbGxDbGFzc0luZm9zID0gZmluZEFsbENsYXNzSW5mb3MoKVxuXG4gICAgICAgIENsaWVudC5kaXNwbGF5Q2hhdE1lc3NhZ2UoYGZvdW5kICR7YWxsQ2xhc3NJbmZvcy5sZW5ndGh9IGNsYXNzZXMsIGNvbnZlcnRpbmcgdG8ga290bGluIGNsYXNzZXNgKVxuXG5cbiAgICAgICAgY29uc3QgY2xhc3NOYW1lcyA9IFtcImphdmEubmV0LlVSTENsYXNzTG9hZGVyXCIsXG4gICAgICAgICAgICBcImphdmEubmlvLmZpbGUuUGF0aHNcIixcbiAgICAgICAgICAgIFwiamF2YS51dGlsLkhhc2hNYXBcIixcbiAgICAgICAgICAgIFwiamF2YS51dGlsLkFycmF5TGlzdFwiLFxuICAgICAgICAgICAgXCJqYXZhLnV0aWwuamFyLkphcklucHV0U3RyZWFtXCIsXG4gICAgICAgICAgICBcImphdmEudXRpbC5NYXBcIixcbiAgICAgICAgICAgIFwiY29tLmdvb2dsZS5jb21tb24ucmVmbGVjdC5DbGFzc1BhdGhcIixcbiAgICAgICAgICAgIFwia290bGluLmp2bS5Kdm1DbGFzc01hcHBpbmdLdFwiXG4gICAgICAgIF1cbiAgICAgICAgICAgIC5jb25jYXQoYWxsQ2xhc3NJbmZvcy5tYXAoKGVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5LmdldE5hbWUoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IGp2bUNsYXNzZXMgPSBjbGFzc05hbWVzXG4gICAgICAgICAgICAubWFwKChlbnRyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0aW9uVXRpbC5jbGFzc0J5TmFtZShlbnRyeSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5ICE9IHVuZGVmaW5lZCk7XG4gICAgICAgIGNvbnN0IGp2bUNsYXNzZXNJbktvdGxpbiA9IGp2bUNsYXNzZXNcbiAgICAgICAgICAgIC5tYXAoKGVudHJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEp2bUNsYXNzTWFwcGluZ0t0LmdldEtvdGxpbkNsYXNzKGVudHJ5KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkgIT0gbnVsbCk7XG5cbiAgICAgICAgQ2xpZW50LmRpc3BsYXlDaGF0TWVzc2FnZShgY29udmVydGVkIHRvICR7anZtQ2xhc3Nlc0luS290bGluLmxlbmd0aH0ga290bGluIGNsYXNzZXNgKVxuICAgICAgICBjb25zdCBrb3RsaW5DbGFzc2VzID0gamF2YUNsYXNzZXNcbiAgICAgICAgICAgIC5jb25jYXQoW1xuICAgICAgICAgICAgICAgIC8vIFVzaW5nIHRoZSBpbXBvcnRlZCBjbGFzcyBmcm9tIEBlbWJlZGRlZFxuICAgICAgICAgICAgICAgIFJlZmxlY3Rpb25VdGlsLmNsYXNzQnlOYW1lKFxuICAgICAgICAgICAgICAgICAgICBcIm5ldC5jY2JsdWV4LmxpcXVpZGJvdW5jZS5zY3JpcHQuYmluZGluZ3MuZmVhdHVyZXMuU2NyaXB0TW9kdWxlXCJcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICBdKVxuICAgICAgICAgICAgLmNvbmNhdChldmVudEVudHJpZXMubWFwKChlbnRyeTogYW55KSA9PiAoZW50cnkgYXMgQXJyYXk8YW55PilbMV0pKVxuICAgICAgICAgICAgLm1hcChlbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEp2bUNsYXNzTWFwcGluZ0t0LmdldEtvdGxpbkNsYXNzKGVudHJ5KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5ICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgIC5jb25jYXQoXG4gICAgICAgICAgICAgICAganZtQ2xhc3Nlc0luS290bGluXG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSBuZXcgQXJyYXlMaXN0KGtvdGxpbkNsYXNzZXMpO1xuXG4gICAgICAgIENsaWVudC5kaXNwbGF5Q2hhdE1lc3NhZ2UoYGdlbmVyYXRpbmcgdHlwZXMgZm9yICR7Y2xhc3Nlcy5sZW5ndGh9IGNsYXNzZXNgKVxuICAgICAgICBDbGllbnQuZGlzcGxheUNoYXRNZXNzYWdlKFwidGhpcyBtYXkgdGFrZSBhIHdoaWxlLCBwbGVhc2Ugd2FpdC4uLlwiKTtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICBjb25zdCBnZW5lcmF0ZWQgPSBuZXcgVHNHZW4oXG4gICAgICAgICAgICBjbGFzc2VzLFxuICAgICAgICAgICAgbmV3IEhhc2hNYXAoKSxcbiAgICAgICAgICAgIG5ldyBBcnJheUxpc3QoKSxcbiAgICAgICAgICAgIG5ldyBBcnJheUxpc3QoKSxcbiAgICAgICAgICAgIFwibnVtYmVyXCIsXG4gICAgICAgICAgICBOVUxMXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgdG9kYXkgPSBMb2NhbERhdGUubm93KCk7XG4gICAgICAgIGNvbnN0IGZvcm1hdHRlciA9IERhdGVUaW1lRm9ybWF0dGVyLm9mUGF0dGVybigneS5NLmQnKTtcblxuICAgICAgICBDbGllbnQuZGlzcGxheUNoYXRNZXNzYWdlKFwid3JpdGluZyB0eXBlc1wiKTtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICBjb25zdCBucG1QYWNrID0gbmV3IE5QTUdlbihnZW5lcmF0ZWQsIHBhY2thZ2VOYW1lLFxuICAgICAgICAgICAgYCR7aW5EZXYgPyB0b2RheS5mb3JtYXQoZm9ybWF0dGVyKSA6IExpcXVpZEJvdW5jZS5JTlNUQU5DRS5jbGllbnRWZXJzaW9uXG4gICAgICAgICAgICB9KyR7TGlxdWlkQm91bmNlLklOU1RBTkNFLmNsaWVudEJyYW5jaH0uJHtMaXF1aWRCb3VuY2UuSU5TVEFOQ0UuY2xpZW50Q29tbWl0fWAsXG4gICAgICAgICAgICAvLyBleHRyYUZpbGVzIC0gYWRkIHRoZSBhbWJpZW50IGFuZCBhdWdtZW50YXRpb25zIGZpbGVzXG4gICAgICAgICAgICBgXCJhdWdtZW50YXRpb25zLyoqLyouZC50c1wiLCBcImFtYmllbnQvYW1iaWVudC5kLnRzXCJgLFxuICAgICAgICAgICAgLy8gZXh0cmFUeXBlc1ZlcnNpb24gLSBhZGQgdGhlIGF1Z21lbnRhdGlvbnMgYW5kIGFtYmllbnQgcGF0aHMgIFxuICAgICAgICAgICAgYFwiLi9hdWdtZW50YXRpb25zLypcIiwgXCJhbWJpZW50L2FtYmllbnQuZC50c1wiYCxcbiAgICAgICAgICAgIC8vIG90aGVyRXh0cmFzIC0gYWRkIHRoZSB0eXBlcyBmaWVsZFxuICAgICAgICAgICAgYFwidHlwZXNcIjogXCJhbWJpZW50L2FtYmllbnQuZC50c1wiYCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBcIj49NC4wXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJqdm0tdHlwZXNcIjogW1xuICAgICAgICAgICAgICAgICAgICAgICAgXCIuL3R5cGVzLypcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiLi9hdWdtZW50YXRpb25zLypcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiYW1iaWVudC9hbWJpZW50LmQudHNcIlxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIG5wbVBhY2sud3JpdGVQYWNrYWdlVG8oXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICBQYXRocy5nZXQocGF0aCArIFwiL3R5cGVzLWdlblwiKVxuICAgICAgICApO1xuXG4gICAgICAgIENsaWVudC5kaXNwbGF5Q2hhdE1lc3NhZ2UoXCJwcmludCBlbWJlZGRlZCBzY3JpcHQgdHlwZXMsIHNlZSBsb2cgZm9yIG1vcmUgaW5mbywgdGhvc2UgYXJlIGZvciBtYWludGFpbmFjZSB1c2VcIilcblxuICAgICAgICBjb25zdCBlbWJlZGRlZERlZmluaXRpb24gPSBgXG4vLyBhbWJpZW50LnRzXG4vLyBpbXBvcnRzXG5pbXBvcnQgXCIuLi9hdWdtZW50YXRpb25zL2luZGV4LmQudHNcIlxuJHtqYXZhQ2xhc3Nlc1xuICAgICAgICAgICAgICAgIC5tYXAoKGNsYXp6KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgaW1wb3J0IHsgJHtnZXROYW1lKGNsYXp6KX0gYXMgJHtnZXROYW1lKGNsYXp6KX1fIH0gZnJvbSBcIi4uL3R5cGVzLyR7Y2xhenoubmFtZS5yZXBsYWNlQWxsKFwiLlwiLCBcIi9cIil9XCI7YDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5qb2luKFwiXFxuXCIpfVxuZGVjbGFyZSBnbG9iYWwge1xuXG5cbi8vIGV4cG9ydHNcbiR7Z2xvYmFsRW50cmllc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeVsxXSAhPSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+ICEoZW50cnlbMV0gaW5zdGFuY2VvZiBDbGFzcykpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5WzFdLmNsYXNzICE9IHVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAubWFwKChlbnRyeSkgPT4gYCAgICBleHBvcnQgY29uc3QgJHtlbnRyeVswXX06ICR7Z2V0TmFtZShlbnRyeVsxXS5jbGFzcyl9O2ApXG4gICAgICAgICAgICAgICAgLmpvaW4oXCJcXG5cXG5cIil9XG5cbiR7Z2xvYmFsRW50cmllc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeVsxXSAhPSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5WzFdIGluc3RhbmNlb2YgQ2xhc3MpXG4gICAgICAgICAgICAgICAgLm1hcCgoZW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xhc3NOYW1lID0gZ2V0TmFtZShlbnRyeVsxXSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgc2hvdWxkIHJlbWFpbiB1bmNoYW5nZWQgKGFkZCB5b3VyIHNwZWNpZmljIGNsYXNzIG5hbWVzIGhlcmUpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtlZXBVbmNoYW5nZWQgPSBbJ1NjcmlwdFBhcmFtZXRlclZhbGlkYXRvcicsICdTY3JpcHRVbnNhZmVUaHJlYWQnXS5pbmNsdWRlcyhjbGFzc05hbWUpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChrZWVwVW5jaGFuZ2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCAgICBleHBvcnQgY29uc3QgJHtlbnRyeVswXX06ICR7Y2xhc3NOYW1lfTtgO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIGl0J3MgYW4gaW50ZXJmYWNlIG9yIGNvbmNyZXRlIGNsYXNzXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBZb3UnbGwgbmVlZCB0byBhZGQgbG9naWMgaGVyZSB0byBkZXRlY3QgaW50ZXJmYWNlcyB2cyBjb25jcmV0ZSBjbGFzc2VzXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0ludGVyZmFjZSA9IGZhbHNlOyAvLyBSZXBsYWNlIHdpdGggYWN0dWFsIGludGVyZmFjZSBkZXRlY3Rpb24gbG9naWNcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW50ZXJmYWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAgICAgZXhwb3J0IGNvbnN0ICR7ZW50cnlbMF19OiAke2NsYXNzTmFtZX1fO2A7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBgICAgIGV4cG9ydCBjb25zdCAke2VudHJ5WzBdfTogdHlwZW9mICR7Y2xhc3NOYW1lfV87YDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmpvaW4oXCJcXG5cXG5cIil9XG5cbn1cbmBcblxuICAgICAgICBjb25zdCBpbXBvcnRzRm9yU2NyaXB0RXZlbnRQYXRjaCA9IGBcbi8vIGltcG9ydHMgZm9yXG4ke2V2ZW50RW50cmllcy5tYXAoKGVudHJ5OiBhbnkpID0+IGVudHJ5WzFdKS5tYXAoKGtDbGFzc0ltcGw6IGFueSkgPT4gYGltcG9ydCB0eXBlIHsgJHtrQ2xhc3NJbXBsLnNpbXBsZU5hbWV9IH0gZnJvbSAnLi4vdHlwZXMvJHtrQ2xhc3NJbXBsLnF1YWxpZmllZE5hbWUucmVwbGFjZUFsbChcIi5cIiwgXCIvXCIpfS5kLnRzJ2ApLmpvaW4oXCJcXG5cIil9XG5cblxuYDtcbiAgICAgICAgY29uc3Qgb25FdmVudHNGb3JTY3JpcHRQYXRjaCA9IGBcbi8vIG9uIGV2ZW50c1xuJHtldmVudEVudHJpZXMubWFwKChlbnRyeTogYW55KSA9PiBgb24oZXZlbnROYW1lOiBcIiR7ZW50cnlbMF19XCIsIGhhbmRsZXI6ICgke2VudHJ5WzBdfUV2ZW50OiAke2VudHJ5WzFdLnNpbXBsZU5hbWV9KSA9PiB2b2lkKTogVW5pdDtgKS5qb2luKFwiXFxuXCIpfVxuXG5cbmA7XG5cbiAgICAgICAgQ2xpZW50LmRpc3BsYXlDaGF0TWVzc2FnZShcIkdlbmVyYXRlZCBUeXBlU2NyaXB0IGRlZmluaXRpb25zIHN1Y2Nlc3NmdWxseSFcIik7XG4gICAgICAgIENsaWVudC5kaXNwbGF5Q2hhdE1lc3NhZ2UoYE91dHB1dCBwYXRoOiAke3BhdGh9L3R5cGVzLWdlbmApO1xuXG4gICAgICAgIC8vIE91dHB1dCB0aGUgZ2VuZXJhdGVkIGNvbnRlbnQgdG8gY29uc29sZSBmb3IgZGVidWdnaW5nXG4gICAgICAgIGNvbnNvbGUubG9nKGVtYmVkZGVkRGVmaW5pdGlvbik7XG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgY29uc3QgRmlsZXMgPSBKYXZhLnR5cGUoJ2phdmEubmlvLmZpbGUuRmlsZXMnKVxuICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gUGF0aHMuZ2V0KGAke3BhdGh9L3R5cGVzLWdlbi8ke3BhY2thZ2VOYW1lfS9hbWJpZW50L2FtYmllbnQuZC50c2ApO1xuXG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgRmlsZXMuY3JlYXRlRGlyZWN0b3JpZXMoZmlsZVBhdGguZ2V0UGFyZW50KCkpO1xuXG4gICAgICAgIEZpbGVzLndyaXRlU3RyaW5nKFxuICAgICAgICAgICAgZmlsZVBhdGgsXG4gICAgICAgICAgICBlbWJlZGRlZERlZmluaXRpb24sXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICBKYXZhLnR5cGUoXCJqYXZhLm5pby5jaGFyc2V0LlN0YW5kYXJkQ2hhcnNldHNcIikuVVRGXzhcbiAgICAgICAgKVxuXG4gICAgICAgIC8vIFdyaXRlIHRoZSBTY3JpcHRNb2R1bGUgYXVnbWVudGF0aW9uIGZpbGVcbiAgICAgICAgY29uc3QgYXVnbWVudGF0aW9uQ29udGVudCA9IGAvLyBTY3JpcHRNb2R1bGUgYXVnbWVudGF0aW9uIC0gYWRkcyBldmVudCBoYW5kbGVyIGludGVyZmFjZXNcblxuLy8gRXZlbnQgdHlwZSBpbXBvcnRzXG4ke2ltcG9ydHNGb3JTY3JpcHRFdmVudFBhdGNofVxuaW1wb3J0IHR5cGUgeyBVbml0IH0gZnJvbSAnLi4vdHlwZXMva290bGluL1VuaXQnO1xuXG4vLyBBdWdtZW50IFNjcmlwdE1vZHVsZSB3aXRoIHNwZWNpZmljIGV2ZW50IGhhbmRsZXIgb3ZlcmxvYWRzXG5kZWNsYXJlIG1vZHVsZSAnLi4vdHlwZXMvbmV0L2NjYmx1ZXgvbGlxdWlkYm91bmNlL3NjcmlwdC9iaW5kaW5ncy9mZWF0dXJlcy9TY3JpcHRNb2R1bGUnIHtcbiAgICBpbnRlcmZhY2UgU2NyaXB0TW9kdWxlIHtcbiAgICAgICAgb24oZXZlbnROYW1lOiBcImVuYWJsZVwiIHwgXCJkaXNhYmxlXCIsIGhhbmRsZXI6ICgpID0+IHZvaWQpOiBVbml0O1xuXG4gICAgICAgIC8vIG9uIGV2ZW50cyB3aXRoIHNwZWNpZmljIGV2ZW50IHR5cGVzXG4gICAgICAgICR7b25FdmVudHNGb3JTY3JpcHRQYXRjaH1cbiAgICB9XG59XG5gO1xuXG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgY29uc3QgYXVnbWVudGF0aW9uRmlsZVBhdGggPSBQYXRocy5nZXQoYCR7cGF0aH0vdHlwZXMtZ2VuLyR7cGFja2FnZU5hbWV9L2F1Z21lbnRhdGlvbnMvU2NyaXB0TW9kdWxlLmF1Z21lbnRhdGlvbi5kLnRzYCk7XG5cbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICBGaWxlcy5jcmVhdGVEaXJlY3RvcmllcyhhdWdtZW50YXRpb25GaWxlUGF0aC5nZXRQYXJlbnQoKSk7XG5cbiAgICAgICAgRmlsZXMud3JpdGVTdHJpbmcoXG4gICAgICAgICAgICBhdWdtZW50YXRpb25GaWxlUGF0aCxcbiAgICAgICAgICAgIGF1Z21lbnRhdGlvbkNvbnRlbnQsXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICBKYXZhLnR5cGUoXCJqYXZhLm5pby5jaGFyc2V0LlN0YW5kYXJkQ2hhcnNldHNcIikuVVRGXzhcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhpbXBvcnRzRm9yU2NyaXB0RXZlbnRQYXRjaCk7XG4gICAgICAgIGNvbnNvbGUubG9nKG9uRXZlbnRzRm9yU2NyaXB0UGF0Y2gpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgQ2xpZW50LmRpc3BsYXlDaGF0TWVzc2FnZShgRXJyb3IgZ2VuZXJhdGluZyBUeXBlU2NyaXB0IGRlZmluaXRpb25zOiAkeyhlIGFzIFRocm93YWJsZSkubWVzc2FnZX1gKTtcbiAgICAgICAgKGUgYXMgRXhjZXB0aW9uKS5wcmludFN0YWNrVHJhY2UoKVxuICAgICAgICB0aHJvdyBlO1xuICAgIH1cbn1cblxuY29uc3QgcGFja2FnZU5hbWUgPSBpbkRldiA/IFwianZtLXR5cGVzLW5leHRcIiA6IFwianZtLXR5cGVcIlxuY29uc3QgcGF0aCA9IFNjcmlwdE1hbmFnZXIuSU5TVEFOQ0Uucm9vdC5wYXRoO1xuXG4vLyBAdHMtZXhwZWN0LWVycm9yXG5pZiAoSmF2YS50eXBlKFwiamF2YS5sYW5nLlN5c3RlbVwiKS5nZXRlbnYoXCJDSV9CVUlMRFwiKSkge1xuICAgIHdvcmsocGF0aCwgcGFja2FnZU5hbWUpXG4gICAgbWMuY2xvc2UoKTtcbn1cblxuc2NyaXB0LnJlZ2lzdGVyQ29tbWFuZCh7XG4gICAgbmFtZTogXCJ0cy1kZWZnZW5cIixcbiAgICBhbGlhc2VzOiBbXCJ0c2dlblwiXSxcbiAgICBwYXJhbWV0ZXJzOiBbXG4gICAgXSxcbiAgICBvbkV4ZWN1dGUoKSB7XG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgVW5zYWZlVGhyZWFkLnJ1bigoKSA9PiB3b3JrKHBhdGgsIHBhY2thZ2VOYW1lKSk7XG4gICAgfVxufSk7XG4iXX0=